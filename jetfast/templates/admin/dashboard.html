{% extends 'admin/base_site.html' %}
{% load static %}

{% block title %}Dashboard - JetFast{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
    :root {
        --primary-color: #fdb02e;
        --primary-dark: #e59a1f;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
        --danger-color: #dc3545;
        --bg-light: #f8f9fa;
    }

    /* Layout Principal */
    .dashboard-container {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Header do Dashboard */
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .dashboard-header h1 {
        margin: 0;
        color: #333;
    }

    .filter-section {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .filter-section select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        height: fit-content;
    }

    .filter-section input[type="date"] {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .filter-section button {
        padding: 8px 16px;
        background: var(--primary-color);
        color: #000;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: background 0.2s;
    }

    .filter-section button:hover {
        background: var(--primary-dark);
    }

    .custom-date-filter {
        display: none;
        align-items: center;
        gap: 10px;
        margin-left: 15px;
        padding-left: 15px;
        border-left: 2px solid #ddd;
    }

    .custom-date-filter.active {
        display: flex;
    }

    /* Cards de Indicadores */
    .indicators-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .indicator-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid var(--primary-color);
        transition: transform 0.2s;
    }

    .indicator-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .indicator-label {
        font-size: 14px;
        color: #666;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .indicator-value {
        font-size: 36px;
        font-weight: bold;
        color: #333;
    }

    .indicator-subtitle {
        font-size: 12px;
        color: #999;
        margin-top: 5px;
    }

    /* Grid de Gr√°ficos */
    .charts-grid {
        display: grid;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .chart-card.full-width {
        grid-column: 1 / -1;
    }

    .chart-row {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }

    .chart-row-three {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
    }

    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    /* Tabela de An√°lise */
    .analysis-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .analysis-section h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
    }

    .analysis-table {
        width: 100%;
        border-collapse: collapse;
    }

    .analysis-table thead {
        background: var(--bg-light);
    }

    .analysis-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #ddd;
    }

    .analysis-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    .analysis-table tbody tr:hover {
        background: #f9f9f9;
    }

    /* Badges */
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-success {
        background: #d4edda;
        color: #155724;
    }

    .badge-info {
        background: #d1ecf1;
        color: #0c5460;
    }

    .badge-warning {
        background: #fff3cd;
        color: #856404;
    }

    /* Estat√≠sticas do Dia */
    .today-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .today-stat {
        flex: 1;
        background: var(--bg-light);
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid var(--info-color);
    }

    .today-stat .label {
        font-size: 12px;
        color: #666;
        font-weight: 600;
    }

    .today-stat .value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-top: 5px;
    }

    /* Bot√£o */
    .btn-primary {
        background: var(--primary-color);
        color: #000;
        padding: 8px 16px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chart-row, .chart-row-three {
            grid-template-columns: 1fr;
        }

        .indicators-grid {
            grid-template-columns: 1fr;
        }

        .filter-section {
            flex-direction: column;
            align-items: stretch;
        }

        .custom-date-filter {
            margin-left: 0;
            padding-left: 0;
            border-left: none;
            border-top: 2px solid #ddd;
            padding-top: 15px;
            margin-top: 15px;
        }
    }
</style>
{% endblock %}

{% block extrahead %}
{{ block.super }}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>üìä Dashboard de Desempenho</h1>
        <div class="filter-section">
            <label for="filtro-dias">Per√≠odo:</label>
            <select id="filtro-dias" onchange="alterarTipoFiltro()">
                <option value="7" {% if dias_filtro == '7' %}selected{% endif %}>√öltimos 7 dias</option>
                <option value="15" {% if dias_filtro == '15' %}selected{% endif %}>√öltimos 15 dias</option>
                <option value="30" {% if dias_filtro == '30' and modo_filtro == 'predefinido' %}selected{% endif %}>√öltimos 30 dias</option>
                <option value="60" {% if dias_filtro == '60' %}selected{% endif %}>√öltimos 60 dias</option>
                <option value="90" {% if dias_filtro == '90' %}selected{% endif %}>√öltimos 90 dias</option>
                <option value="tudo" {% if dias_filtro == 'tudo' %}selected{% endif %}>Tudo</option>
                <option value="custom" {% if modo_filtro == 'custom' %}selected{% endif %}>Intervalo Espec√≠fico</option>
            </select>

            <div id="customDateFilter" class="custom-date-filter {% if modo_filtro == 'custom' %}active{% endif %}">
                <label for="data-inicial">De:</label>
                <input type="date"
                       id="data-inicial"
                       name="data_inicial"
                       value="{{ data_inicial_custom|default:'' }}">

                <label for="data-final">At√©:</label>
                <input type="date"
                       id="data-final"
                       name="data_final"
                       value="{{ data_final_custom|default:'' }}">

                <button onclick="aplicarFiltroCustom()">Aplicar</button>
            </div>
        </div>
    </div>

    <!-- Estat√≠sticas de Hoje -->
    <div class="today-stats">
        <div class="today-stat">
            <div class="label">LAVAGENS HOJE</div>
            <div class="value">{{ lavagens_hoje }}</div>
        </div>
        <div class="today-stat">
            <div class="label">CONCLU√çDAS HOJE</div>
            <div class="value" style="color: var(--success-color);">{{ lavagens_concluidas_hoje }}</div>
        </div>
    </div>

    <!-- Indicadores Principais -->
    <div class="indicators-grid">
        <div class="indicator-card" style="border-left-color: var(--info-color);">
            <div class="indicator-label">Total de Lavagens</div>
            <div class="indicator-value">{{ indicadores.total_lavagens }}</div>
            <div class="indicator-subtitle">{{ periodo_label }}</div>
        </div>

        <div class="indicator-card" style="border-left-color: var(--success-color);">
            <div class="indicator-label">Tempo M√©dio de Lavagem</div>
            <div class="indicator-value" style="font-size: 32px;">{{ indicadores.tempo_medio_lavagem }}</div>
            <div class="indicator-subtitle">Da pista at√© a sa√≠da</div>
        </div>

        <div class="indicator-card" style="border-left-color: var(--warning-color);">
            <div class="indicator-label">Tempo M√©dio de Fila</div>
            <div class="indicator-value" style="font-size: 32px;">{{ indicadores.tempo_medio_fila }}</div>
            <div class="indicator-subtitle">Da chegada at√© a pista</div>
        </div>

        <div class="indicator-card" style="border-left-color: var(--danger-color);">
            <div class="indicator-label">Tempo M√©dio Total</div>
            <div class="indicator-value" style="font-size: 32px;">{{ indicadores.tempo_medio_total }}</div>
            <div class="indicator-subtitle">Da chegada at√© a sa√≠da</div>
        </div>
    </div>

    <!-- Gr√°ficos -->
    <div class="charts-grid">
        <!-- Lavagens por Dia - Linha completa -->
        <div class="chart-card full-width">
            <h3>üìà Lavagens por Dia</h3>
            <div class="chart-container">
                <canvas id="chartLavagensPorDia"></canvas>
            </div>
        </div>

        <!-- Distribui√ß√£o por Categoria, Tipo de Cliente e Produtividade - Mesma linha -->
        <div class="chart-row-three">
            <div class="chart-card">
                <h3>üè∑Ô∏è Distribui√ß√£o por Categoria</h3>
                <div class="chart-container">
                    <canvas id="chartCategoria"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>üë§ Tipo de Cliente</h3>
                <div class="chart-container">
                    <canvas id="chartTipoCliente"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <h3>üë• Produtividade por Colaborador</h3>
                <div class="chart-container">
                    <canvas id="chartColaborador"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabela de An√°lise por Categoria -->
    <div class="analysis-section">
        <h3>üìã An√°lise Detalhada por Categoria</h3>
        <table class="analysis-table">
            <thead>
                <tr>
                    <th>Categoria</th>
                    <th style="text-align: center;">Quantidade</th>
                    <th style="text-align: center;">Tempo M√©dio de Lavagem</th>
                    <th style="text-align: center;">Tempo M√©dio de Fila</th>
                    <th style="text-align: center;">Tempo M√©dio Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in analise_categorias %}
                <tr>
                    <td><strong>{{ item.categoria }}</strong></td>
                    <td style="text-align: center;">
                        <span class="badge badge-info">{{ item.total_lavagens }}</span>
                    </td>
                    <td style="text-align: center;">{{ item.tempo_medio_lavagem }}</td>
                    <td style="text-align: center;">{{ item.tempo_medio_fila }}</td>
                    <td style="text-align: center;">
                        <strong>{{ item.tempo_medio_total }}</strong>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px; color: #999;">
                        Nenhum dado dispon√≠vel para o per√≠odo selecionado
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}

{% block footer %}
{{ block.super }}

<script>
// Configura√ß√µes globais do Chart.js
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.color = '#666';

// ========================================
// Gr√°fico: Lavagens por Dia
// ========================================
const ctxDia = document.getElementById('chartLavagensPorDia').getContext('2d');
new Chart(ctxDia, {
    type: 'line',
    data: {
        labels: {{ lavagens_por_dia_labels|safe }},
        datasets: [{
            label: 'Lavagens',
            data: {{ lavagens_por_dia_data|safe }},
            borderColor: '#fdb02e',
            backgroundColor: 'rgba(253, 176, 46, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#fdb02e',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                    size: 14
                },
                bodyFont: {
                    size: 13
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// ========================================
// Gr√°fico: Distribui√ß√£o por Categoria
// ========================================
const ctxCategoria = document.getElementById('chartCategoria').getContext('2d');
const coresCategoria = [
    '#fdb02e',
    '#28a745',
    '#17a2b8',
    '#dc3545',
    '#6c757d',
    '#ffc107',
    '#007bff'
];

new Chart(ctxCategoria, {
    type: 'doughnut',
    data: {
        labels: {{ distribuicao_categoria.labels|safe }},
        datasets: [{
            data: {{ distribuicao_categoria.data|safe }},
            backgroundColor: coresCategoria,
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 15,
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// ========================================
// Gr√°fico: Tipo de Cliente
// ========================================
const ctxTipoCliente = document.getElementById('chartTipoCliente').getContext('2d');
new Chart(ctxTipoCliente, {
    type: 'bar',
    data: {
        labels: {{ distribuicao_tipo_cliente.labels|safe }},
        datasets: [{
            label: 'Lavagens',
            data: {{ distribuicao_tipo_cliente.data|safe }},
            backgroundColor: ['#007bff', '#28a745'],
            borderColor: ['#0056b3', '#1e7e34'],
            borderWidth: 2,
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// ========================================
// Gr√°fico: Produtividade por Colaborador
// ========================================
const ctxColaborador = document.getElementById('chartColaborador').getContext('2d');
new Chart(ctxColaborador, {
    type: 'bar',
    data: {
        labels: {{ produtividade.labels|safe }},
        datasets: [{
            label: 'Lavagens',
            data: {{ produtividade.data|safe }},
            backgroundColor: 'rgba(253, 176, 46, 0.8)',
            borderColor: '#fdb02e',
            borderWidth: 2,
            borderRadius: 5
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                },
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// ========================================
// Filtro de Per√≠odo
// ========================================
function alterarTipoFiltro() {
    const select = document.getElementById('filtro-dias');
    const valor = select.value;
    const customFilter = document.getElementById('customDateFilter');

    if (valor === 'custom') {
        customFilter.classList.add('active');

        const hoje = new Date();
        const trintaDiasAtras = new Date();
        trintaDiasAtras.setDate(hoje.getDate() - 30);

        document.getElementById('data-final').value = hoje.toISOString().split('T')[0];
        document.getElementById('data-inicial').value = trintaDiasAtras.toISOString().split('T')[0];
    } else {
        customFilter.classList.remove('active');
        aplicarFiltro();
    }
}

function aplicarFiltro() {
    const dias = document.getElementById('filtro-dias').value;
    if (dias !== 'custom') {
        window.location.href = `?dias=${dias}`;
    }
}

function aplicarFiltroCustom() {
    const dataInicial = document.getElementById('data-inicial').value;
    const dataFinal = document.getElementById('data-final').value;

    if (!dataInicial || !dataFinal) {
        alert('Por favor, selecione ambas as datas');
        return;
    }

    if (new Date(dataInicial) > new Date(dataFinal)) {
        alert('A data inicial n√£o pode ser maior que a data final');
        return;
    }

    window.location.href = `?data_inicial=${dataInicial}&data_final=${dataFinal}`;
}
</script>
{% endblock %}